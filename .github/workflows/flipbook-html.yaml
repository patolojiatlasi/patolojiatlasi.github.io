name: Generate Flipbook

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-flipbook:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2

    - name: Set up Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '14'

    - name: Install dependencies
      run: |
        npm install jquery
        npm install turn.js

    - name: Generate Flipbook
      run: |
        mkdir -p flipbook
        cp -R docs/* flipbook/
        
        cat << EOF > flipbook/index.html
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Patoloji Atlasi Flipbook</title>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/turn.js/4.1.0/turn.min.js"></script>
            <style>
                body { margin: 0; }
                #flipbook {
                    width: 100vw;
                    height: 100vh;
                }
                #flipbook .page {
                    background-color: white;
                }
            </style>
        </head>
        <body>
            <div id="flipbook">
                <!-- Pages will be inserted here dynamically -->
            </div>

            <script>
                \$(document).ready(function() {
                    // Load HTML pages
                    \$.ajax({
                        url: 'manifest.json',
                        dataType: 'json',
                        success: function(data) {
                            data.pages.forEach(function(page) {
                                \$('#flipbook').append('<div><iframe src="' + page + '" width="100%" height="100%" frameborder="0"></iframe></div>');
                            });
                            
                            // Initialize turn.js
                            \$('#flipbook').turn({
                                width: '100%',
                                height: '100%',
                                autoCenter: true,
                                responsive: true
                            });
                        }
                    });
                });
            </script>
        </body>
        </html>
        EOF

        # Create a manifest of HTML files
        find flipbook -name "*.html" ! -name "index.html" | sed 's|flipbook/||' | jq -R -s 'split("\n")[:-1] | {pages: .}' > flipbook/manifest.json

    - name: Commit flipbook to repository
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add flipbook
        git commit -m "Update flipbook" -a || echo "No changes to commit"
        git push
        